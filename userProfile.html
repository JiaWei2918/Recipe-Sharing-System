<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <link rel="stylesheet" href="https://fonts.bunny.net/css?family=lora:400,400i,700,700i|playfair-display:400,700|Bebas+Neue&family=Raleway:wght@400;500&display=swap|Orbitron&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="public/userProfile.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script type="module">
        import { auth, db, doc, collection, query, where, getDocs, onAuthStateChanged, updateDoc } from "/public/firebaseInit.js";

        function loadUserProfile() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    const usersRef = collection(db, 'users');
                    const q = query(usersRef, where('uid', '==', user.uid));

                    getDocs(q).then((querySnapshot) => {
                        if (!querySnapshot.empty) {
                            const docSnapshot = querySnapshot.docs[0];
                            const userData = docSnapshot.data();

                            document.getElementById('profile-title-text').innerText = `${userData.username}'s Recipe Box`;
                            document.getElementById('profilePic').src = userData.photoURL || 'public/images/usernotlogin.JPG';
                            document.getElementById('profileDescription').innerText = userData.description || 'No Bio';
                            document.getElementById('xLink').innerText = userData.x || 'X';
                            document.getElementById('instagramLink').innerText = userData.instagram || 'Instagram';
                            document.getElementById('pinterestLink').innerText = userData.pinterest || 'Pinterest';
                        } else {
                            console.log("User does not exist.");
                        }
                    }).catch((error) => {
                        console.log("Error getting document:", error);
                    });

                    loadSubmittedRecipes(user.uid);
                } else {
                    console.log("No user is signed in.");
                    window.location.href = "userLogin.html";
                }
            });
        }

        function loadSubmittedRecipes(userId) {
            const recipesRef = collection(db, 'recipes');
            const q = query(recipesRef, where("userId", "==", userId));

            getDocs(q).then((querySnapshot) => {
                const submittedRecipesContainer = document.getElementById('submittedRecipes');
                submittedRecipesContainer.innerHTML = '';
        
                if (querySnapshot.empty) {
                    // Display a message if there are no recipes
                    submittedRecipesContainer.innerHTML = '<p class="text-muted">No recipes submitted yet.</p>';
                } else {
                    querySnapshot.forEach((docSnapshot) => {
                        const recipe = docSnapshot.data();
                        const recipeCard = `
                            <div class="col-md-4 mb-4">
                                <div class="card">
                                    <img src="${recipe.image}" class="card-img-top" alt="Recipe Image">
                                    <div class="card-body">
                                        <h5 class="card-title">${recipe.title}</h5>
                                        <p class="card-text"><small>${recipe.cookTime}</small></p>
                                    </div>
                                </div>
                            </div>`;
                        submittedRecipesContainer.innerHTML += recipeCard;
                    });
                }
            }).catch((error) => {
                console.log("Error getting recipes:", error);
                document.getElementById('submittedRecipes').innerHTML = '<p class="text-danger">Unable to load recipes. Please try again later.</p>';
            });
        }

        function toggleEditMode() {
            const profileView = document.getElementById('profileView');
            const profileEdit = document.getElementById('profileEdit');
            if (profileView.style.display === 'none') {
                profileView.style.display = 'block';
                profileEdit.style.display = 'none';
            } else {
                const currentProfilePic = document.getElementById('profilePic').src;
                document.getElementById('editProfilePic').src = currentProfilePic;
                document.getElementById('profilePicInput').value = currentProfilePic;
                
                profileView.style.display = 'none';
                profileEdit.style.display = 'block';
            }
        }

        async function saveProfile() {
            try {
                const q = query(collection(db, 'users'), where('uid', '==', auth.currentUser.uid));
                const querySnapshot = await getDocs(q);

                if(!querySnapshot.empty) {
                    const userDoc = querySnapshot.docs[0];
                    const userRef = userDoc.ref;

                    const updatedData = {
                        description: document.getElementById('editProfileDescription').value,
                        x: document.getElementById('x').value,
                        instagram: document.getElementById('instagram').value,
                        pinterest: document.getElementById('pinterest').value,
                        photoURL: document.getElementById('profilePicInput').value,
                    };

                    await updateDoc(userRef, updatedData);
                    alert("Profile changes saved.");
                    toggleEditMode();
                    loadUserProfile();
                } else {
                    console.error("User document not found.");
                    alert("Error: User document not found.");
                }
            } catch (error) {
                console.error("Error updating profile:", error);
            }
        }

        function downloadProfile() {
            const profileElement = document.getElementById('profile');

            html2canvas(profileElement).then(canvas => {
                const imageDataURL = canvas.toDataURL("image/png");

                const downloadLink = document.createElement("a");
                downloadLink.href = imageDataURL;
                downloadLink.download = "profile.png";

                document.body.appendChild(downloadLink);
                downloadLink.click();
                document.body.removeChild(downloadLink);

                alert("Download successful! Your profile image has been saved.");
            }).catch(error => {
                console.error("Error capturing profile:", error);
                alert("Download failed. Please try again."); 
            });
        }

        function goBack() {
            window.history.back();
        }

        window.onload = () => {
            loadUserProfile();

            document.getElementById('edit-icon').addEventListener('click', toggleEditMode);
            document.getElementById('cancelButton').addEventListener('click', toggleEditMode);
            document.getElementById('saveProfile').addEventListener('click', saveProfile);
            document.getElementById('downloadProfile').addEventListener('click', downloadProfile);
            document.getElementById('goBackIcon').addEventListener('click', goBack);
        }
    </script>

    <script>
        function selectPhoto(photoPath) {
            document.getElementById('editProfilePic').src = photoPath;
            document.getElementById('profilePicInput').value = photoPath;
        }
    </script>
</head>
<body>
    <div class="container my-5" id="profile">
        <div class="text-center mb-4">
            <h2 class="profile-title" id="profile-title">
                <a href="#" id="goBackIcon">
                    <img src="public/images/back.png" alt="Back" class="back-icon">
                </a>
                <span id="profile-title-text">User's Recipe Box</span>
                <i class="fas fa-edit" id="edit-icon" style="cursor: pointer;"></i>
                <i class="fas fa-file-arrow-down" id="downloadProfile" style="cursor: pointer;"></i>
            </h2>
        </div>

        <div id="profileView">
            <div class="row align-items-center">
                <div class="col-md-3 text-center">
                    <img id="profilePic" class="rounded-circle mb-3" alt="Profile Picture" width="120" height="120">
                </div>
                <div class="col-md-9">
                    <p id="profileDescription" class="profile-description">No Bio.</p>
                    <div class="d-flex align-items-center">
                        <img src="public/images/square-x-twitter-brands-solid.svg" alt="x" id="xIcon" width="24" height="24">
                        <a href="#" id="xLink"></a>
                        <i class="fab fa-instagram"><a href="#" id="instagramLink"></a></i>
                        <i class="fab fa-pinterest"><a href="#" id="pinterestLink"></a></i>
                    </div>
                </div>
            </div>
        </div>

        <div id="profileEdit" style="display: none;">
            <form>
                <div class="row align-items-center">
                    <div class="col-md-3 text-center">
                        <img id="editProfilePic" class="rounded-circle mb-3" alt="Profile Picture" width="120" height="120">
                        <input type="hidden" id="profilePicInput">

                        <div id="photoGallery" class="photo-gallery">
                            <p>Select a profile picture:</p>
                            <img src="account-photo/p1.jpg" alt="Profile Option" class="profile-option" onclick="selectPhoto('account-photo/p1.jpg')">
                            <img src="account-photo/p2.png" alt="Profile Option" class="profile-option" onclick="selectPhoto('account-photo/p2.png')">
                            <img src="account-photo/p3.png" alt="Profile Option" class="profile-option" onclick="selectPhoto('account-photo/p3.png')">
                            <img src="account-photo/p4.jpg" alt="Profile Option" class="profile-option" onclick="selectPhoto('account-photo/p4.jpg')">
                            <img src="account-photo/p5.jpg" alt="Profile Option" class="profile-option" onclick="selectPhoto('account-photo/p5.jpg')">
                            <img src="account-photo/p6.png" alt="Profile Option" class="profile-option" onclick="selectPhoto('account-photo/p6.png')">
                            <img src="account-photo/p7.jpg" alt="Profile Option" class="profile-option" onclick="selectPhoto('account-photo/p7.jpg')">
                            <img src="account-photo/p8.png" alt="Profile Option" class="profile-option" onclick="selectPhoto('account-photo/p8.png')">
                            <img src="account-photo/p9.jpg" alt="Profile Option" class="profile-option" onclick="selectPhoto('account-photo/p9.jpg')">
                            <img src="account-photo/p10.jpg" alt="Profile Option" class="profile-option" onclick="selectPhoto('account-photo/p10.jpg')">
                            <img src="account-photo/p11.png" alt="Profile Option" class="profile-option" onclick="selectPhoto('account-photo/p11.png')">
                            <img src="account-photo/p12.png" alt="Profile Option" class="profile-option" onclick="selectPhoto('account-photo/p12.png')">
                            <img src="account-photo/p13.png" alt="Profile Option" class="profile-option" onclick="selectPhoto('account-photo/p13.png')">
                            <img src="account-photo/p14.png" alt="Profile Option" class="profile-option" onclick="selectPhoto('account-photo/p14.png')">
                            <img src="account-photo/p15.png" alt="Profile Option" class="profile-option" onclick="selectPhoto('account-photo/p15.png')">
                        </div>
                    </div>
                    <div class="col-md-9">
                        <textarea id="editProfileDescription" class="form-control profile-description" rows="5">No Bio.</textarea>
                        <div class="d-flex flex-column align-items-start mt-3">
                            <label for="x" class="mb-2">X username:</label>
                            <input type="text" id="x" class="form-control mb-2" placeholder="@emmag">
                            
                            <label for="instagram" class="mb-2">Instagram username:</label>
                            <input type="text" id="instagram" class="form-control mb-2" placeholder="@emmag">

                            <label for="pinterest" class="mb-2">Pinterest username:</label>
                            <input type="text" id="pinterest" class="form-control mb-2" placeholder="emmagonzalez">
                        </div>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <button type="button" class="btn btn-primary" id="saveProfile">Save Changes</button>
                    <button type="button" class="btn btn-secondary" id="cancelButton">Cancel</button>
                </div>
            </form>
        </div>

        <ul class="nav nav-tabs mt-4" id="recipeTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="submitted-tab" data-bs-toggle="tab" data-bs-target="#submitted" type="button" role="tab">Submitted Recipes</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="saved-tab" data-bs-toggle="tab" data-bs-target="#saved" type="button" role="tab">Saved Recipes</button>
            </li>
        </ul>

        <div class="tab-content" id="recipeTabContent">
            <div class="tab-pane fade show active" id="submitted" role="tabpanel" aria-labelledby="submitted-tab">
                <div class="row mt-4" id="submittedRecipes"></div>
            </div>
            <div class="tab-pane fade" id="saved" role="tabpanel" aria-labelledby="saved-tab">
                <div class="row mt-4" id="savedRecipes"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
</body>
</html>
